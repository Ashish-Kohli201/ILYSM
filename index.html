<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Anniversary Road Trip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; touch-action: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* CAR HUD CONTROLS (Mobile) */
        .control-btn {
            background: rgba(0,0,0,0.1); border: 2px solid rgba(0,0,0,0.2);
            border-radius: 12px; backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: #333; user-select: none;
            transition: background 0.1s, transform 0.1s;
        }
        .control-btn:active { background: rgba(0,0,0,0.3); transform: scale(0.95); }
        
        /* Layout for controls */
        #controls-area {
            display: none; /* Hidden on desktop initially */
            position: absolute; bottom: 20px; left: 0; right: 0; height: 140px;
            padding: 0 20px; pointer-events: none;
        }
        .pointer-events-auto { pointer-events: auto; }
        
        @media (pointer: coarse) {
            #controls-area { display: flex; justify-content: space-between; }
        }

        /* Instructions */
        .key-badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            background: #ddd; border-bottom: 2px solid #bbb; font-size: 10px; font-weight: bold; color: #555;
        }

        /* Checkpoint Pulse Animation */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="start-screen" class="fixed inset-0 z-50 bg-[#e0e7ff] flex flex-col items-center justify-center transition-opacity duration-500">
        <h1 class="text-4xl md:text-6xl font-bold text-indigo-900 tracking-tighter mb-2">ROAD TRIP</h1>
        <p class="text-indigo-600 mb-8 tracking-widest uppercase text-xs">Year Two Anniversary Edition</p>
        
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 mb-8">
            <h3 class="font-bold text-gray-700 mb-2">How to Play:</h3>
            <ul class="text-sm text-gray-500 space-y-2">
                <li>üöó Drive the car to explore the map.</li>
                <li>üìç Find the <strong>Glowing Zones</strong>.</li>
                <li>üõë <strong>Park</strong> inside them to unlock a memory.</li>
            </ul>
        </div>

        <button id="start-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
            START ENGINE
        </button>
    </div>

    <div id="ui-layer" class="absolute inset-0 pointer-events-none z-10 p-6 opacity-0 transition-opacity duration-1000">
        <div class="flex justify-between items-start">
            <div class="bg-white/80 backdrop-blur px-4 py-2 rounded-lg shadow-sm">
                <p class="text-xs font-bold text-indigo-900">MEMORY MAP</p>
            </div>
            <div class="hidden md:block bg-white/80 backdrop-blur px-4 py-2 rounded-lg shadow-sm">
                <p class="text-xs text-gray-500">
                    <span class="key-badge">W</span> Gas 
                    <span class="key-badge">S</span> Brake 
                    <span class="key-badge">A</span> Left 
                    <span class="key-badge">D</span> Right
                </p>
            </div>
        </div>

        <div id="park-alert" class="absolute top-1/4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-6 py-2 rounded-full font-bold tracking-widest text-sm opacity-0 transition-all duration-300 transform scale-90">
            PARKING...
        </div>
    </div>

    <div id="controls-area">
        <div class="flex gap-4 items-end pb-4">
            <div id="btn-left" class="control-btn w-16 h-16 pointer-events-auto">‚Üê</div>
            <div id="btn-right" class="control-btn w-16 h-16 pointer-events-auto">‚Üí</div>
        </div>
        <div class="flex gap-4 items-end pb-4">
            <div id="btn-brake" class="control-btn w-16 h-16 pointer-events-auto bg-red-500/10 border-red-500/30 text-red-800">S</div>
            <div id="btn-gas" class="control-btn w-16 h-20 pointer-events-auto bg-green-500/10 border-green-500/30 text-green-800">W</div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl overflow-hidden shadow-2xl max-w-md w-full transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="relative h-64 bg-gray-100">
                <img id="modal-img" src="" class="w-full h-full object-cover">
                <button onclick="closeModal()" class="absolute top-3 right-3 bg-white/90 text-gray-800 w-8 h-8 rounded-full font-bold shadow hover:bg-white">‚úï</button>
            </div>
            <div class="p-8">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                <div class="w-10 h-1 bg-indigo-500 mb-4"></div>
                <p id="modal-desc" class="text-gray-600 leading-relaxed"></p>
                <button onclick="closeModal()" class="w-full mt-6 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg transition">
                    Back to Driving
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA: EDIT YOUR MEMORIES HERE ---
        const CHECKPOINTS = [
            {
                x: -15, z: -15, color: 0xFF6B6B, // Red Zone
                img: "https://placehold.co/600x400/FF6B6B/FFF?text=First+Date",
                title: "Where It Started",
                desc: "Parked here to remember our first date. I was so nervous picking you up."
            },
            {
                x: 15, z: -15, color: 0x4ECDC4, // Teal Zone
                img: "https://placehold.co/600x400/4ECDC4/FFF?text=The+Trip",
                title: "Road Trip",
                desc: "Driving 500 miles just to see the ocean. Best weekend ever."
            },
            {
                x: 15, z: 15, color: 0xFFD93D, // Yellow Zone
                img: "https://placehold.co/600x400/FFD93D/FFF?text=Home",
                title: "Building a Home",
                desc: "Even when things got messy, we built something beautiful."
            },
            {
                x: -15, z: 15, color: 0x6C5CE7, // Purple Zone
                img: "https://placehold.co/600x400/6C5CE7/FFF?text=Future",
                title: "The Future",
                desc: "Buckle up. We have so many more places to go together."
            }
        ];

        // --- 2. ENGINE & SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f5ff); // Soft blue-ish white
        scene.fog = new THREE.Fog(0xf0f5ff, 20, 60);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        // Initial Camera Position (Isometric-ish)
        camera.position.set(20, 20, 20);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
        dirLight.position.set(50, 80, 30);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.camera.left = -50;
        dirLight.shadow.camera.right = 50;
        dirLight.shadow.camera.top = 50;
        dirLight.shadow.camera.bottom = -50;
        scene.add(dirLight);

        // --- 3. GAME OBJECTS ---

        // FLOOR
        const floorGeo = new THREE.PlaneGeometry(200, 200);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0xeef2f3 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // DECORATION: Random Blocks (Buildings)
        const cityGroup = new THREE.Group();
        const boxGeo = new THREE.BoxGeometry(1, 1, 1);
        const boxMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
        
        for(let i=0; i<40; i++) {
            const h = Math.random() * 4 + 1;
            const mesh = new THREE.Mesh(boxGeo, boxMat);
            // Don't spawn near center (0,0)
            let x = (Math.random() - 0.5) * 80;
            let z = (Math.random() - 0.5) * 80;
            if (Math.abs(x) < 5 && Math.abs(z) < 5) x += 10;

            mesh.position.set(x, h/2, z);
            mesh.scale.set(Math.random()*2+1, h, Math.random()*2+1);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            cityGroup.add(mesh);
        }
        scene.add(cityGroup);

        // THE CAR (Simple Low Poly)
        const carGroup = new THREE.Group();
        
        // Body
        const bodyGeo = new THREE.BoxGeometry(2, 0.8, 3.5);
        const bodyMat = new THREE.MeshStandardMaterial({ color: 0x4f46e5 }); // Indigo car
        const carBody = new THREE.Mesh(bodyGeo, bodyMat);
        carBody.position.y = 0.8;
        carBody.castShadow = true;
        carGroup.add(carBody);

        // Cabin
        const cabinGeo = new THREE.BoxGeometry(1.8, 0.6, 1.5);
        const cabinMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
        const carCabin = new THREE.Mesh(cabinGeo, cabinMat);
        carCabin.position.y = 1.5;
        carCabin.position.z = -0.3;
        carCabin.castShadow = true;
        carGroup.add(carCabin);

        // Wheels
        const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.4, 16);
        const wheelMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const wheelPos = [
            {x: 1.1, y: 0.4, z: 1}, {x: -1.1, y: 0.4, z: 1},
            {x: 1.1, y: 0.4, z: -1.2}, {x: -1.1, y: 0.4, z: -1.2}
        ];
        wheelPos.forEach(p => {
            const w = new THREE.Mesh(wheelGeo, wheelMat);
            w.rotation.z = Math.PI / 2;
            w.position.set(p.x, p.y, p.z);
            w.castShadow = true;
            carGroup.add(w);
        });

        // Headlights
        const lightGeo = new THREE.SphereGeometry(0.2);
        const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffaa });
        const h1 = new THREE.Mesh(lightGeo, lightMat); h1.position.set(0.6, 0.8, 1.8);
        const h2 = new THREE.Mesh(lightGeo, lightMat); h2.position.set(-0.6, 0.8, 1.8);
        carGroup.add(h1, h2);

        // Headlight Beams
        const spotL = new THREE.SpotLight(0xffffee, 2, 20, 0.5, 0.5, 1);
        spotL.position.set(0, 1, 1);
        spotL.target.position.set(0, 0, 10);
        carGroup.add(spotL);
        carGroup.add(spotL.target);

        scene.add(carGroup);


        // CHECKPOINTS (Visuals)
        const markers = [];
        CHECKPOINTS.forEach(cp => {
            const group = new THREE.Group();
            group.position.set(cp.x, 0.05, cp.z);

            // Ring
            const ringGeo = new THREE.RingGeometry(2, 2.5, 32);
            const ringMat = new THREE.MeshBasicMaterial({ color: cp.color, side: THREE.DoubleSide, transparent: true, opacity: 0.6 });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = -Math.PI / 2;
            group.add(ring);

            // Floating Icon
            const iconGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const iconMat = new THREE.MeshBasicMaterial({ color: cp.color });
            const icon = new THREE.Mesh(iconGeo, iconMat);
            icon.position.y = 1;
            // Animation data
            icon.userData = { offset: Math.random() * 10 }; 
            group.add(icon);

            scene.add(group);
            markers.push({ group, icon, data: cp, active: true });
        });

        // --- 4. CAR PHYSICS (Arcade Style) ---
        const carState = {
            speed: 0,
            maxSpeed: 0.6,
            acceleration: 0.015,
            friction: 0.96,
            turnSpeed: 0.04,
            rotation: 0,
            x: 0, 
            z: 0,
            vx: 0, 
            vz: 0
        };

        const input = { up: false, down: false, left: false, right: false };

        // Desktop Inputs
        window.addEventListener('keydown', (e) => {
            if(e.key === 'w' || e.key === 'ArrowUp') input.up = true;
            if(e.key === 's' || e.key === 'ArrowDown') input.down = true;
            if(e.key === 'a' || e.key === 'ArrowLeft') input.left = true;
            if(e.key === 'd' || e.key === 'ArrowRight') input.right = true;
        });

        window.addEventListener('keyup', (e) => {
            if(e.key === 'w' || e.key === 'ArrowUp') input.up = false;
            if(e.key === 's' || e.key === 'ArrowDown') input.down = false;
            if(e.key === 'a' || e.key === 'ArrowLeft') input.left = false;
            if(e.key === 'd' || e.key === 'ArrowRight') input.right = false;
        });

        // Mobile Inputs
        const bindTouch = (id, key) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); input[key] = true; el.style.background = 'rgba(0,0,0,0.2)'; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); input[key] = false; el.style.background = ''; });
        };
        bindTouch('btn-gas', 'up');
        bindTouch('btn-brake', 'down');
        bindTouch('btn-left', 'left');
        bindTouch('btn-right', 'right');

        // --- 5. GAME LOOP ---
        let isGameActive = false;
        let parkingTimer = 0;
        let activeCheckpoint = null;

        function updateCar() {
            if(!isGameActive) return;
            if(document.getElementById('modal').classList.contains('hidden') === false) return; // Stop if modal open

            // Acceleration
            if (input.up) carState.speed += carState.acceleration;
            if (input.down) carState.speed -= carState.acceleration;

            // Friction
            carState.speed *= carState.friction;

            // Turning (only when moving)
            if (Math.abs(carState.speed) > 0.01) {
                const direction = carState.speed > 0 ? 1 : -1;
                if (input.left) carState.rotation += carState.turnSpeed * direction;
                if (input.right) carState.rotation -= carState.turnSpeed * direction;
            }

            // Apply Velocity
            carState.vx = Math.sin(carState.rotation) * carState.speed;
            carState.vz = Math.cos(carState.rotation) * carState.speed;

            carState.x += carState.vx;
            carState.z += carState.vz;

            // Update Mesh
            carGroup.position.set(carState.x, 0, carState.z);
            carGroup.rotation.y = carState.rotation;
        }

        function updateCamera() {
            // Smooth Camera Follow
            const targetX = carState.x - Math.sin(carState.rotation) * 20; // 20 units behind
            const targetZ = carState.z - Math.cos(carState.rotation) * 20;
            
            // Lerp camera position
            camera.position.x += (targetX - camera.position.x) * 0.05 + 1; // +1 bias for angle
            camera.position.z += (targetZ - camera.position.z) * 0.05;
            camera.position.y = 15; // Constant height

            camera.lookAt(carState.x, 0, carState.z);
        }

        function checkInteractions() {
            let nearby = false;
            const carPos = new THREE.Vector3(carState.x, 0, carState.z);

            markers.forEach(marker => {
                // Animate marker
                marker.icon.rotation.y += 0.02;
                marker.icon.position.y = 1 + Math.sin(Date.now() * 0.005 + marker.icon.userData.offset) * 0.2;

                // Check distance
                const dist = carPos.distanceTo(marker.group.position);
                
                if (dist < 3.5) {
                    nearby = true;
                    activeCheckpoint = marker.data;

                    // Trigger parking logic
                    if (Math.abs(carState.speed) < 0.1) {
                        // Car is basically stopped
                        parkingTimer++;
                        const alert = document.getElementById('park-alert');
                        alert.style.opacity = 1;
                        alert.style.transform = 'scale(1) translateX(-50%)';
                        
                        if (parkingTimer > 60) { // 1 second park
                            openModal(marker.data);
                            parkingTimer = 0;
                        }
                    } else {
                        parkingTimer = 0;
                        document.getElementById('park-alert').style.opacity = 0;
                    }
                }
            });

            if (!nearby) {
                parkingTimer = 0;
                document.getElementById('park-alert').style.opacity = 0;
            }
        }

        function openModal(data) {
            // Stop car
            carState.speed = 0;
            input.up = input.down = false;

            const m = document.getElementById('modal');
            document.getElementById('modal-img').src = data.img;
            document.getElementById('modal-title').innerText = data.title;
            document.getElementById('modal-desc').innerText = data.desc;
            
            m.classList.remove('hidden');
            setTimeout(() => {
                m.classList.remove('opacity-0');
                document.getElementById('modal-content').classList.remove('scale-95');
            }, 50);
        }

        window.closeModal = function() {
            const m = document.getElementById('modal');
            m.classList.add('opacity-0');
            document.getElementById('modal-content').classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
            
            // Reset car position slightly to avoid instant re-trigger
            // (Optional, or just require driving out)
        }

        function animate() {
            requestAnimationFrame(animate);
            updateCar();
            updateCamera();
            checkInteractions();
            renderer.render(scene, camera);
        }

        // Start Logic
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-screen').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('start-screen').style.display = 'none';
                isGameActive = true;
            }, 500);
            document.getElementById('ui-layer').style.opacity = 1;
        });

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
